<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<head>

	<title> Roll Decay Simulation And Analysis </font></title>


<style>
a:link {font-family:monospace; font-size:12px; font-style:italic;}
a:hover { color: green;}

</style>

    <script src="three.min105.js"></script>
	
	 <script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/OrbitControls.js"></script> 	
 	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/OBJLoader.js"></script>
	<script src="https://unpkg.com/three@0.109.0/examples/js/loaders/TDSLoader.js"></script>
	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/water-material.js"></script> 	
	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/jquery-1.8.3.min.js"></script>	
	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/flot.min.js"></script>	
	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/flot.time.js"></script>	
	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/flot.axislabels.js"></script>	
	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/flot.dashes.js"></script>	
	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/numeric-126min.js"></script>	
	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/lodash.min.js"></script>	
	<script src="https://gitcdn.link/repo/msahli2/Shipnumerics/master/FOLDER_2020/regression.js"></script>
	<script src="https://cdn.statically.io/gl/Msahli/shipnumerics/master/FOLDER2020/Tween.js"></script>
	<script src="https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/dsp3.js"></script>
<!-- 


    <script src="three.min105.js"></script> 
	<script src="jquery-1.8.3.min.js"></script>	
	<script src="OBJLoader.js"></script>
	<script src="TDSLoader.js"></script>	
	<script src="OrbitControls.js"></script> 
 	<script src="water-material.js"></script> 	
	<script src="numeric-126min.js"></script>
	
	<script src="flot.min.js"></script>
	<script src="flot.time.js"></script>	
	<script src="flot.axislabels.js"></script>	
	<script src="flot.dashes.js"></script>		
	
	<script src="lodash.min.js"></script>	
	<script src="dsp.js"></script>	 
	<script src="regression.js"></script>	
	<script src="PolynomialRegression.min.js"></script>	
	
	<script src='Tween.js'></script>
-->		  
	
</head>


<script>
		var samlpeSize = 1024;	//   256  512  1024  2048  
		var signalrandom = numeric.rep([samlpeSize], 0); //[];
		var signaluniform =[];		
		var signalTime =[];
		var samplingWindow = 0;
		var samplingInterval = 0;
		var samplingRate = 0; 
		var limit0=0;	 
		var iBrt=0;
				
		var Phim=0;
		var dPhi=0;
		var NBrtn=0;
		var PhimTab = [],PhimTimTab = [],PhiDltTab = [];
		var dPhiTab = [];
		var NBrtnTab = [];
		var PhimTimeTab = [];	
		var PhimMeanTime = 0;	
		var PhimOldTime = 0;				
		var BERTINpos = 0.0;
		var BERTINneg = 0.0;		
		var MULT0 = -1;
		var result = null,result2 = null;
		var coeff = null,coeff2 = null;
		var equationtxt = '',equationtxt2 = '';
		var FFT_RollT =null;
		var RollT =null;	
      
		var PI = Math.PI
		var w = 2*PI/FFT_RollT
		

		
		function TweenRotate( obj, angles, delay, pause ) {  // with help from https://github.com/tweenjs/tween.js/issues/14
		new TWEEN.Tween(obj.rotation)
				.delay(pause)
				.to({x: obj.rotation._x + angles.x,	y: obj.rotation._y + angles.y,z: obj.rotation._z + angles.z },delay)
				.onComplete(function() {
				   //setTimeout( tRotate, pause, obj, angles, delay, pause );
				}).start();
		}
		

		var WebSocket,ipValue1; 
		function ConnectWebSocket(){ 
			ipValue1 = "shipnumerics.freemyip.com";  
			ipValue2 = "shipnumerics.duckdns.org";  
			ipValue3 = "shipnumerics..ddns.net";
			
			WebSocket = new WebSocket( 'ws://' + ipValue1 + ':58');   //http://192.168.1.50/  ("ws://site_url:8765"); 
			WebSocket.onopen = function (event) { console.log("/!\\ Connexion serveur"); } 
			WebSocket.onerror = function (event) { console.log(event); } 
			WebSocket.onmessage = function (event) { console.log(event.data); } 
			WebSocket.onclose = function (event) { console.log("/!\\ DÃ©connexion serveur"); } 
		}		
		
		
		
		
		
		
		
 		//Periode /////////////////////////////////////////////////////////////////// 
		function Periode(ts) { //https://github.com/corbanbrook/dsp.js
//console.log("tststststststststststs33333333333333333333333" , ts)		        
			    //if 	(limit0 <= samlpeSize) {                         //if samlpes <  samlpeSize 
				signalTime[limit0]= ts ;                         // ts Populate limit0  Array
				signalrandom[limit0]= Roll0[0] ;                 // Populate signalrandom Array /Troll*PI/180;
			
				//ROLL DAMPING  _____________________________________________________________________________________________________________________________________________
				var i=limit0;
				var SNG = Math.sign( signalrandom[i] - signalrandom[i-1])	
				// BERTINpos = 0; BERTINneg = 0;  timeSeries.data = [];
				document.getElementById('container30').innerHTML = '<pre>' + " SampleSize/" + samlpeSize 
																 + '<BR>'  + " Sampling  /" + limit0   					
				                                                 + '<BR>'  + " Time0     /" + time0.toFixed(3) 				
				                                                 + '<BR>'  + " Time      /" + signalTime[limit0].toFixed(3) 
																 + '<BR>'  + " Signal    /" + signalrandom[limit0].toFixed(3) 
															     + '<BR>'  + " Sign      /" + SNG  	;

															 //+ '<BR>'  + " PhimTab[0];/" + PhimTab[0]   	 
 	                                                         	 
				if (SNG == -MULT0) // Advise:Here When curve coordinates Diff Change sign   here Data collection
				{   //IKEDA Prediction Of Ship Roll Damping Fortran Code.pdf p 26
					
					// Time count for positive and negative values
					if (signalrandom[i] > 0) {BERTINpos = 1*signalrandom[i]; Dumpline4.push([ts.toFixed(4) ,BERTINpos.toFixed(4)] );}// 
					if (signalrandom[i] < 0) {BERTINneg = 1*signalrandom[i]; Dumpline5.push([ts.toFixed(4) ,BERTINneg.toFixed(4)] );}




					if (signalrandom[i] > 0 ){ 
						PhimTimTab[iBrt]=+signalTime[limit0];  dPhiTab[iBrt]=signalrandom[i];    NBrtnTab[iBrt]=+NBrtn;
					    iBrt = iBrt + 1; //  Bertin peacks counter for //Bertin coefficient mean calculation
					}
					MULT0=-MULT0 ;	//for peack differentiation
					
				}
				//document.getElementById('container31').innerHTML  =signalTime[limit0].toFixed(4)  //PhimTab[0];
			   // document.getElementById('container31').innerHTML  ='<pre>'   +'limit0/ ' + limit0 +'  time0/ ' + time0 + '  samlpeSize/ ' + samlpeSize ;//
				
				limit0 = limit0 + 1;    //  samlpling counter
			
			//}
			//else 
			//ROLL DAMPING  _____________________________________________________________________________________________________________________________________________
			if 	(limit0 == samlpeSize) {       // Begin Process after sampling number reach samlpeSize
			//if 	(time0 >= 30 & time0 < 31) {       // GRAPH BERTIN's //////////////////////////
 
				//plotWithOptions();           //plot BERTINpos BERTINneg
//console.log("Dumpline4Dumpline4Dumpline4Dumpline4Dumpline4" , Dumpline4)
		
				//Damping polynomial fitting  with regression.js
				result = regression('polynomial', Dumpline4,3 ); // {order:3, precision:4, period:null }
				coeff = result.equation;
				equationtxt = result.string;        		 //var predicty =  regression('polynomial', Dumpline4,3).predict(10);
				document.getElementById('Extinctionquation').innerHTML = 'Extinc Eq/' + equationtxt ; //+ ' predicty '+ predicty
				
		        //Decrement  Curve --------------------------------------------------
				//for (i=1;i<1.0*signalTime[samlpeSize-1].toFixed(0);i++){              //t0 is an artfact to enlarge fft scale
				var strt = signalTime[0].toFixed(0), end = signalTime[samlpeSize-1].toFixed(0) ;
				for (i= strt; i< end ;i++){   				
				    var eq = coeff[3]*(i*i*i) +coeff[2]*(i*i)+ coeff[1]*i+coeff[0]//result.predict(i)
					Dumpline7.push( [i,eq] );    //Build Roll Spectrum Curve for ...//One pass Roll FFT Spectrum Curve Drawing
				}	//plotFixed();
								
				//const poly =  PolynomialRegression.read(Dumpline4, 3);
				//const terms =  runTest(Dumpline4, 3) ; //poly.getTerms();
				//coeff = terms
				//const regressionData = someData.map((data) => ({ x: data.x,   y: poly.predictY(terms, data.x)  }));				
							
					
				//FFT _____________________________________________________________________________________________________________________________________________				
				// if samlpes >  samlpeSize 
				if ( signalrandom.length == samlpeSize+1 ) signalrandom.splice(signalrandom.length-1,1); // delete last elment 1025/cause samlpeSize =1024 
	//document.getElementById('container30').innerHTML +='<pre>'+ signalrandom.length ;
				//if (! isNaN(RollT)) {
				//document.getElementById('container3').innerHTML ='<pre>'+ PhimMeanTime.toFixed(2)+ ' ' + limitB + ' ' + RollT.toFixed(2);  // 
				//}

				samplingWindow = (signalTime[samlpeSize-1] -signalTime[0]); 
				samplingInterval = samplingWindow /samlpeSize; 
				samplingRate = 1 /samplingInterval ;
				//signaluniform.clear

				signaluniform = signalrandom; 
				var fft = new FFT(samlpeSize,samplingRate);        //FFT Prerequisites
				fft.forward(signaluniform);                                 //FFT.forward(signalrandom);
				var spectrum = fft.spectrum;

				//https://dsp.stackexchange.com/questions/26927/what-is-a-frequency-bin
				var k = spectrum.indexOf(Math.max.apply(null, spectrum) );	// frequency bin:How to compute frequency of data using FFT?
				//var FFT_RollT =  1/(samplingRate * k /samlpeSize)    ;  //^ -1
				FFT_RollT =samlpeSize/(samplingRate*k) ;  
				if ( FFT_RollT < 100) rollPeriode = FFT_RollT.toFixed(2); 
				/*
				document.getElementById('container30').innerHTML +=+ '<BR>'  
																   + '<BR>'  + " frequency-bin/ " + k  	 
																   + '<BR>'  + " FFT_RollT/ " + FFT_RollT.toFixed(2)  ;   // 	 
				*/						
				if (! isNaN(FFT_RollT)) {		
					document.getElementById('rollperiode').innerHTML =  'Frequency_bin:' + k  
																		+ '<BR>'  +'FFT Roll Period' //+ FFT_RollT.toFixed(2) // +'|'+ ppp.toFixed(2).toString() ; 
																		+ '<BR>'  +'__Size__'	+ ' =' + FFT_RollT.toFixed(2)
																		+ '<BR>'  +'(Rate.bin)';
					//SPECTRUM CURVE ------------------------------------------------------
					var t0= 0; //new Date().getTime()		 //var t0 = startTime.getTime();	
					for (i=1;i<samlpeSize;i++){              //t0 is an artfact to enlarge fft scale
						if (t0  > tmax )  break; 
						if (i == k ) Dumpline6b.push( [t0,1*spectrum[i]] )  ; //Bin red Point 
						Dumpline6.push( [t0,1*spectrum[i]] );    //Build Roll Spectrum Curve for ...//One pass Roll FFT Spectrum Curve Drawing
						t0+= 1.5;  //scale factor
					}	
					plotWithOptionsFFT();   //GRAPH FFT's //////////////////////////
				   //setTimeout(10000);	
				}

				//Bertin coefficient mean calculation
				Phim = (dPhiTab[1] + dPhiTab[0]) / 2 ;       // PhimTab.reduce((x, y) => x + y) ; // output: 15
				dPhi =  dPhiTab[0] - dPhiTab[1]  ;
				NBrtn = (180/3.1416)*dPhi/(Phim*Phim) ;
			
			    //Time Periode
                PhimMeanTime = PhimTimTab[1] - PhimTimTab[0];				
				RollT = PhimMeanTime;
				iBrt = 0;                                    // samlpeSize counter RZ	
				
				//Damping equation & real time points plotting
				//PhimTab.push([Phim.toFixed(4)]) ;          // ***************************************************
				//PhiDltTab.push([dPhi.toFixed(4)]) ;        // ***************************************************

			
				document.getElementById('container32').innerHTML = '<pre>' +'Bertin'+ "'" +'s coefficient'   
							+ '<BR>'  + 'Î¦m:' +  Phim.toFixed(4)
							+ '<BR>'  + 'ÎÎ¦:' +  dPhi.toFixed(4)
							+ '<BR>'  + 'N =(180/Ï).ÎÎ¦/Î¦mÂ² :' +  NBrtn.toFixed(4) //+ '       â B44 = '
							+ '<BR>'  
							//+ '<BR>'  + 'Timer Roll Period(Including processing time) :' + RollT.toFixed(2)  + ' '
							+ '<BR>'  + 'FFT   Roll Period :samlpeSize/(samplingRate*frequency_bin) :' + FFT_RollT.toFixed(2)  
							+ '<BR>'  
							//+ '<BR>'  + 'Decay Equation ' + equationtxt  ;//coeff[3].toFixed(4)+'xÂ³ + ' + coeff[2].toFixed(2)+'xÂ² + ' + coeff[1].toFixed(2)+'x + ' + coeff[0].toFixed(2)//+ equationtxt	
							

				Dumpline8.push( [Phim.toFixed(4),dPhi.toFixed(4)] );  //points plotting: sequential/incremental plotting of  Î¦m & ÎÎ¦  in Decrement graph points
				//After 3 Decays
				if (Dumpline8.length == ntest ){			          //final process of Î¦m & ÎÎ¦
					Dumpline8x.push( [0,0] );                         //Decrement polynome strictly cubic d=0  so insert 0,0
					Dumpline8x = Dumpline8x.concat(Dumpline8);

					//Damping polynomial fitting
					result2 = regression('polynomial', Dumpline8x,3 ); // {order:3, precision:4, period:null }
					coeff2 = result2.equation;
					equationtxt2 = result2.string;	//var predicty =  regression('polynomial', Dumpline4,3).predict(10);
					//document.getElementById('container31').innerHTML = 'Decay Eq /' + equationtxt2 ; //+ ' predicty '+ predicty

					for(var i = 0; i < Dumpline8.length; i++){	      Dumpline88[i] = Dumpline8[i].slice(0);}ï»¿		
																	  //curve plotting: 
					
					var PI = Math.PI
					var w=2*PI/FFT_RollT
					var a=coeff2[1],b=coeff2[2],c=coeff2[3];
					//var Î±=a*w/PI, Î²=(3/4)*b ,Î³=8*c/(3*PI*w)  ;
					var Î±=a*w/PI, Î²=135*b/PI,Î³=((180/PI)*(180/PI)) * 8*c/(3*PI*w);
					
					document.getElementById('decrementequation').innerHTML = 'Î Eq ' + equationtxt2  //coeff[3].toFixed(4)+'xÂ³ + ' + coeff[2].toFixed(2)+'xÂ² + ' + coeff[1].toFixed(2)+'x + ' + coeff[0].toFixed(2)//+ equationtxt	
					document.getElementById('container32').innerHTML += '<pre>' + 'Decrement Equation ' + equationtxt2  //coeff[3].toFixed(4)+'xÂ³ + ' + coeff[2].toFixed(2)+'xÂ² + ' + coeff[1].toFixed(2)+'x + ' + coeff[0].toFixed(2)//+ equationtxt	
								+ '<BR>'  + 'Î±,Î²,Î³ Respectively linear,quadratic and cubic roll Damping coefficients '
								+ '<BR>'  + 'Î±:' +Î±.toFixed(8) + ' Î²:' +Î².toFixed(8) + ' Î³:' +Î³.toFixed(8) ;
								// + '<BR>'  + ' Damped Roll Equation  Î¦' + "'' + " + '2Î±Î¦'' +" + " +  'Î²|Î¦' +"|'" + 'Î¦' +"' + " + "Î³Î¦" + "'Â³"    
	  
					//Dumpline8.splice(0,Dumpline8.length);   //deny  continous loop process
					//Dumpline8.push( [0,0] );
console.log('Decrement Equation ' + equationtxt2   + 
							  ' '  + 'Î±,Î²,Î³ Respectively linear,quadratic and cubic roll Damping coefficients '  +
							  ' '  + 'Î±: ' +Î±.toFixed(8) + '  Î²:' +Î².toFixed(8) + '  Î³:' +Î³.toFixed(8))					
					
				}
				plotWithOptionsDAMP();  // 1st 2nd ----> plot points  3rd plot 3rd point then the damping curve defined by the 3 points
				// document.getElementById('container31').innerHTML = Dumpline88;
					
 			
		        NEXTROLL(Phi0);  plotFixed();   //plot Stataic  Roll curve
				Phi0=Phi0+10;;
                if 	(Dumpline8.length < ntest ) {TweenRotate(Geo, {x:Phi0*Math.PI/180,y:0,z:0}, 1500, 0 );
	                            		    	 document.getElementById('NEXTRoll').innerHTML = 'Next Roll Amplitude ' +  Phi0;			
				}
				//Dumpline4.splice(0,Dumpline4.length);  Dumpline5.splice(0,Dumpline5.length); Dumpline6.splice(0,Dumpline6.length); 
				//line6b.splice(0,line6b.length); Dumpline7.splice(0,Dumpline7.length);
				
				//signalTime.splice(0,signalTime.length);
				//signalrandom.splice(0,signalrandom.length);
				
				//PhimTimTab.splice(0,PhimTab.length);   dPhiTab.splice(0,dPhiTab.length);  
				NBrtnTab.splice(0,NBrtnTab.length); 
				
				//MULT0 = -1;
				//setTimeout(10000);
//---------------------------------------------------------------------------------------------------------------------------------				
				
			} 
			

						 
		} ;



</script>





<body     topmargin="0" leftmargin="20" rightmargin="0" style=" line-height:90%;" >
 
 
	<h2><font size="4" color="red"> <i> Roll Decay Simulation And Analysis </i></font>  <font size="1" color="black">  </font>
	 <font size="1" color="black">   rev/Any Ship </font> 
	
	</h2>
 	
	
	
	<script>

	document.write('Simulation     / ' + "<a href=\"https://raw.githubusercontent.com/msahli2/Shipnumerics/master/HTMLSOLUTION/RollDecay.html\">" );
	//document.write('Simulation     / ' + "<a href=\"example.html\">" );
	document.write("Basic Code behind"+ "</a>");
 
    document.write( "<br><br>" +'Ship Data /');
	</script>


	<pre style="font-family:courier; font-size:11px; " >
  ls=60m  B=13m  GMt=2m  Vol=1200m3  ro=1.025  g=9.81 
  Hydrodynamic Data :
    Ixx & C44  / As defined in IMO SDC4-5-1-Add.1-Apx.3
    Ixx = 0.2*ro*vol*Math.pow(B,2) ;
    C44 = ro*g*vol*GMt;
    B44        / Estimated by empirical formula	
    B44 = 2*0.1*Math.sqrt(Ixx*C44);
	</pre> 
	
	<script>	
	document.write("<p style='position:absolute; top:210px; left:30px; font-size:12px;'>");
	//document.write("<a href=\example.html\">" + "3D file" + "</a>" );
	document.write("<a href=\"https://raw.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/FishBoat1.3ds\">" + "3D file" + "</a>" );
	document.write("</p><br>"); 
	</script>	
	
	<div id='container0' align='left' style='position:absolute; line-height:180%; border:0px solid gray; border-radius:4px;line-height:100%; color:r; border-radius:4px;  height:350px; width:630px; left:15px; top:260px;'>  
		
		<p style="position:absolute; top:-10px; left:5px;" > Analysis  <font size="2" color="black">   <i>/ According to ITTC Guidelines 7.5-02-07-04.5/Â§3.3 </i> </font>  </p>
		
		<div id='container32' align='left' style='position:absolute; line-height:200%; padding-left:6px; border:1px solid gray; border-radius:4px;line-height:100%; color:black; border-radius:4px; font-size:11px; height:128px; width:585px; left:26px; top:25px;'></div>  
		
	  <div  style="position:absolute; width:305px;height:180px; left:-3px; top:5px;  "> 
		<div id="aware"    style=" position:absolute;    width:305px;height:10px;  left:10px;  top:155px; font-family:arial; font-weight:bold; font-size:11px; "></div>
		<div id="G_motion" style="position:absolute; width:305px;height:190px; left:10px;  top:165px; font-family:arial; font-weight:bold; font-size:12px; "></div>
		<div id="G_FFT"    style="position:absolute; width:162px;height:190px; left:310px; top:165px; font-family:arial; font-weight:bold; font-size:12px; "></div>
		<div id="G_DAMP"   style="position:absolute; width:162px;height:190px; left:467px; top:165px; font-family:arial; font-weight:bold; font-size:12px; "></div>
		<div id="rollperiode"       style="position:absolute; width:120px; left:385px; top:200px; color:black; font-family:calibri; font-size:11px; "> FFT Roll Period :</div>		
		<div id="decrementequation" style="border:0px solid gray;  position:absolute;  top:285px; width:120px; height:30px; left:490px; color:black; font-family:calibri; font-size:11px; "> Î Eq /:</div>		
		<div id="Extinctionquation" style="width:300px; position:absolute; left:34px;  top:300px; color:black; font-family:calibri; font-size:11px; "> Extinction Eq /  :</div>		
	  </div>

	  <div  style="position:absolute; width:305px;height:180px; left:5px; top:350px;  "> 
		<button ID='Roll' onclick='ButtonRoll(); ' style='position:absolute; background-color:black; border-radius:4px; border:none; color:white; left:10px; top:20px; width:100px; height:15px;font-family:calibri; font-size:11px; z-index:1000 '>Roll Decay</button> 
		<div ID='NEXTRoll' style='position:absolute;  color:white; left:485px; top:250px; width:150px; height:20px;font-family:calibri; font-size:11px; z-index:1000 '> </div> 

		<div id="3d"  style="position:absolute; border-radius:6px; border:1px solid gray; width:620px; height:250px;left:-2px; top:15px; ">	</div>
		<div id='container30' align='left' style='border:0px solid gray; border-radius:4px;line-height:100%; color:white; border-radius:4px; font-family:arial; font-size:11px; position:absolute; height:100px; width:100px; left:485px; top:10px; z-index:1000'></div>  
		<div id='container31' align='left' style='border:0px solid gray; border-radius:4px;line-height:100%; color:red; border-radius:4px; font-family:arial; font-size:11px; position:absolute; height:100px; width:100px; left:485px; top:110px; z-index:1100'></div>  
	  </div>
	  
	</div>
	
	<script>
	
	//var renderer =new THREE.WebGLRenderer({antialias: true	});
	var renderer, container, scene, camera, controls;
	var water = new THREE.Object3D;
	var Geo = new THREE.Object3D();
	var ocean0 = new THREE.Object3D;
	var RollDecay = false;
    var plott;	
	
	var SCREEN_WIDTH = 610; //762
	var SCREEN_HEIGHT = 260;  //top:465px; right:0;
	
    var LPP = 80, DEPTH = 8 ;  //30 80
    //var LPP =30, DEPTH = 3 ;  //30 80

	//line8.push( [0,0] );	// Decrement polynome strictly cubic d=0
	
			renderer = new THREE.WebGLRenderer({antialias: true	});
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setClearColor(0xA9CCE3, 1);
			
			container = document.getElementById('3d');// get the div that will hold the renderer
			container.appendChild(renderer.domElement);// add the renderer to the div
		
			scene = new THREE.Scene();
	 
			// prepare camera
			var VIEW_ANGLE =25, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.01, FAR = 10000;     //VIEW_ANGLE = 41,         
			camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR); 
			camera.position.set(0.5*LPP, 0.4*LPP,1.0*LPP );	
			scene.add(camera);
			
			controls = new THREE.OrbitControls(camera, renderer.domElement);
			controls.enablePan = true; 
			controls.enableDamping=true; //lagt til nettopp.
			controls.maxPolarAngle =  0.98*Math.PI/2; //Don't let go below the ocean
			controls.target.set(3,DEPTH,0);	//(0,3,0) PAN	//controls.target = new THREE.Vector3( 0,0, 0 )  ;//center;
			controls.update();
			
		    //update renderer and scene in container
			renderer.setSize(container.clientWidth, container.clientHeight);
			camera.aspect = container.clientWidth / container.clientHeight;
			camera.updateProjectionMatrix();
		
			//Add lights:
			scene.add(new THREE.AmbientLight(0xffffff, 0.1));
			var DirectionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
			DirectionalLight.position.set(1*LPP, 0.3*LPP, 0.3*LPP);				
			scene.add(DirectionalLight)

    function Skydome() {	
        //scene.remove(skydome); 	 //THREE.ImageUtils.crossOrigin = '';	   night effect  	
	    var texture = new THREE.TextureLoader().load('https://rawcdn.githack.com/msahli2/Shipnumerics/395306ac37a424a36f2c37900c9d97ad22231a0c/FOLDER_2020/sky4.jpg'); 
	    //var texture = new THREE.TextureLoader().load('sky4.jpg'); 
  		var geometry = new THREE.SphereGeometry(1000, 1000, 50);        
		var material =   new THREE.MeshBasicMaterial({map:texture, transparent:true, opacity:0.2 }) ; 
		material.side = THREE.BackSide;
		skydome = new THREE.Mesh(geometry, material);
		skydome.position.set(0,0,0);  // skydome.rotation.y = 30*PI;
	    scene.add(skydome);  
		//setTimeout( Ocean()  ,1000);
	} 			
	
	function Skybox() {
	    var size2 =2048;
		var cubeMap = new THREE.CubeTexture([]);
		cubeMap.format = THREE.RGBFormat;
		var loader = new THREE.ImageLoader();
		//loader.load( 'skyboxsun.png', function ( image ) {	
		loader.load( 'https://cdn.statically.io/gh/msahli2/Shipnumerics/2396b05d/FOLDER_2020/skyboxsun.png', function ( image ) {			
 		        var getSide = function ( x, y ) {
				var size = 1024;
				var canvas = document.createElement( 'canvas' );
				canvas.width = size;	canvas.height = size;
				var context = canvas.getContext( '2d' );
				context.drawImage( image, - x * size, - y * size );
				return canvas;
			};
			cubeMap.images[ 0 ] = getSide( 2, 1 ); cubeMap.images[ 1 ] = getSide( 0, 1 ); // px  nx
			cubeMap.images[ 2 ] = getSide( 1, 0 ); cubeMap.images[ 3 ] = getSide( 1, 2 ); // py  ny
			cubeMap.images[ 4 ] = getSide( 1, 1 ); cubeMap.images[ 5 ] = getSide( 3, 1 ); // pz  nz
			cubeMap.needsUpdate = true;
		 } );
		var cubeShader = THREE.ShaderLib[ 'cube' ];
		cubeShader.uniforms[ 'tCube' ].value = cubeMap;
		var skyBoxMaterial = new THREE.ShaderMaterial( {fragmentShader:cubeShader.fragmentShader,
			vertexShader:cubeShader.vertexShader, uniforms:cubeShader.uniforms,	depthWrite:false, side: THREE.BackSide} );

		var skyBox =new THREE.Mesh(new THREE.BoxBufferGeometry( size2, size2, size2 ),skyBoxMaterial	);		
		//skyBox.rotation.x += Math.PI / 2;
		scene.add( skyBox );		
	} 
	
	//Sea*************************************************************************************************************	
    function Ocean() {	//https://www.browserling.com/tools/image-to-base64
		 
	    var planeMaterial = new THREE.MeshBasicMaterial({color:0x0008f9 ,  wireframe:  true});  // 0x10BFBF  0x0008f9  0x10BFBF
       // var waterNormals = new THREE.TextureLoader().load( 'waterNormals.jpg' ); //waternormals wave4 wave3 wave2   wave1  waterdudv  water
         //var waterNormals = new THREE.TextureLoader().load( 'https://rawcdn.githack.com/msahli2/Shipnumerics/master/FOLDER_2020/waternormals.jpg' );  //wave4 wave3 wave2   wave1  waterdudv  water
       var waterNormals = new THREE.TextureLoader().load( 'https://rawcdn.githack.com/msahli2/Shipnumerics/ceae00f16d5038b75ede21a513fb891accaccd1b/FOLDER_2020/waternormals.png' );  //wave4 wave3 wave2   wave1  waterdudv  water

        waterNormals.wrapS = waterNormals.wrapT = THREE.RepeatWrapping;
        water = new THREE.Water( renderer, camera, scene, {
             waterNormals: waterNormals,
			normalSampler:    null ,
			mirrorSampler:    null ,
			alpha:            1.0 ,
			time:             0.0 ,
			distortionScale:  20.0 ,
			noiseScale:       1.0 ,
			textureMatrix :   new THREE.Matrix4() ,
			sunColor:         new THREE.Color( 0x7F7F7F ) ,
			sunDirection:     new THREE.Vector3( 0.70707, 0.70707, 0 ) ,
			eye:              new THREE.Vector3() ,
			waterColor:       new THREE.Color( 0x555555 ) 
        } );
	
		var waterGeometry = new THREE.PlaneGeometry(2000,2000,100,50 ) ;
		Ocean0 = new THREE.Mesh( waterGeometry,  water.material  );		//water.receiveShadow = false;
		Ocean0.add( water );  
 		scene.add( Ocean0 ); 
	    Ocean0.rotation.x = - PI * 0.5; Ocean0.rotation.z = 45*PI/180;   
 		
		water.castShadow = true;
		water.receiveShadow  = true;
		//setTimeout( Ship()  ,1000);
    }	
	
	var SHIP= new THREE.Object3D;;		
	function Ship() { 
			//Ship*************************************************************************************************************
	/*
			var loader = new THREE.OBJLoader();
			var material0 = new THREE.MeshPhongMaterial({ color:0x156289, transparent:true, opacity:1 });   //669933 0099cc 		
			var material4 = new THREE.MeshPhongMaterial({ color:0x9a7d0a, transparent:true, opacity:1,  });   
			
			loader.load('UBC1.obj', function(SHIP) { 	
				//apply custom material for all children         0x9a7d0a 0x156289 lightseagreen mediumseagreen  008800  9a7d0a     2874a6 
				material = new THREE.MeshPhongMaterial({ color:0x9a7d0a, transparent:false, opacity:1  });    
				SHIP.traverse( function (child) { if (child instanceof THREE.Mesh) geometry = child.geometry; child.material = material4; });   
				SHIP.position.set(-LPP/2,0,0) ; SHIP.material.side = THREE.DoubleSide;
				Geo.add(SHIP); 	scene.add(Geo); 
			});			
	*/ 		
			var loader = new THREE.TDSLoader();
			var material = new THREE.MeshPhongMaterial({ color:0x9a7d0a, transparent:false, opacity:1  });  
			//loader.load( 'FishBoat1.3ds', function ( object ) { //FishBoat1  UBC
			loader.load( 'https://rawcdn.githack.com/msahli2/Shipnumerics/6f72f50e558ba8c475cd3e418b031067b7c65229/FOLDER_2020/FishBoat1.3ds', function ( object ) {
			object.traverse( function ( child ) {if ( child.isMesh ) { child.material.opacity =1 ; }} );
			object.rotation.x = -Math.PI/2 ;  object.position.set(-LPP/2,-0.8,0); 
			scene.add(Geo);	
			Geo.add(object);
				
			} );
	}		
	 
		
		//GRAPH PLOTTING
		var Dumpx_motion = [],Dumpx_motiond = [];	
		var Dumplinex=[], Dumpliney=[],Dumpline4=[],  Dumpline5=[], Dumpline6=[],Dumpline6b=[], Dumpline7=[], Dumpline8=[], Dumpline88=[], Dumpline8x=[];		
		
		var d1_points = {show:false, radius:1, fillColor:"red"};	
		var d2_points = {show:true, radius:2,  fillColor:"green"};	
		var d3_points = {show:true, radius:2,  fillColor:"orange"};	
		var d4_points = {show:true, radius:2,  fillColor:"white"};	
		var d5_points = {show:true, radius:2,  fillColor:"blue"};
          		
		var tmax = 50; // sec
		var Phi0 = 5;
		var ntest = 3;
		//var angle = [2,12,22];
		
		Dumplinex.push([-Phi0,0]);   Dumplinex.push([25,0]);
		Dumpliney.push([0,-Phi0-1]); Dumpliney.push([0,Phi0+1]);
		
		var datasetFixed = [
			{color:"black",   lines:{fill:false, lineWidth:0.3, show:true}, shadow:{show:true},  data:Dumplinex,  },// Roll
			{color:"black",   lines:{fill:false, lineWidth:0.3, show:true}, shadow:{show:true},  data:Dumpliney, },// Roll
		
			{color:"blue",   lines:{fill:false, lineWidth:0.8, show:true}, shadow:{show:true}, points:d1_points, data:Dumpx_motion },// Roll
			{color:"blue",   lines:{fill:false, lineWidth:0.8, show:true}, shadow:{show:true}, points:d1_points, data:Dumpx_motiond, label:"Roll"},// Roll			
		    {color:"red",    lines:{fill:false, show:false}, points:{show:true}, points:d2_points, data:Dumpline4, label:"Max"},// Roll
			{color:"orange", lines:{fill:false, show:false}, points:{show:true}, points:d3_points, data:Dumpline5, label:"Min"},// Roll
			{color:"black",  dashes:{show:true, lineWidth:1,dashLength:3},  points:{show:true}, points:d1_points, data:Dumpline7, label:"Damp"},// Roll
		];			
		var datasetFFT = [
			{color:"blue", bars:{show:true, align:"center", barWidth:0.01}, lines:{lineWidth:1.5,fill:false, show:false},  points:{show:false}, points:d1_points, data:Dumpline6, label:"FFT Spectrum"},// Roll	
			{color:"red", lines:{fill:false, show:false}, points:{show:true},  points:d4_points,  data:Dumpline6b }// Roll	
		];			
		
		var datasetDAMP = [
			{color:"red", lines:{fill:false, show:false, lineWidth:1}, points:{show:true}, points:d4_points, data:Dumpline8 },// Roll 
			{color:"blue", dashes:{show:true, lineWidth:2,dashLength:3}, points:{show:false},  data:Dumpline88, label:"Decrement"},// Roll 
		];			
		
		function plotFixed(){
			$.plot("#G_motion", datasetFixed, {
			    //series: { lines: {show:true, lineWidth:0.5, fill:false } },
				xaxis: {min:-1,max:45, tickFormatter: function(val, axis) {return val < axis.max ? val.toFixed(0) : "s";},
				axisLabel:"Roll Decay", axisLabelUseCanvas:true,axisLabelFontSizePixels:10, axisLabelPadding:8,},	//axisLabelFontFamily: 'Verdana, Arial',
	
            	yaxis: {tickFormatter: function(val, axis) {return val < axis.max ? val.toFixed(0) : "D";	}},
				legend:{show:true,position: "ne"},
				grid: {
				backgroundColor: { colors: ["white", "white"] },//backgroundColor: { colors: ["#4ca8fe", "#2887de"] },
				gridLineColor:"red", borderColor:"gray",borderWidth: 1,	margin:-1, hoverable:true }									   
			});
        }  plotFixed() 
				
		function plotWithOptionsFFT(){
			  plott = $.plot("#G_FFT", datasetFFT, {
				xaxis: {min:-1, max:tmax , showTickLabels: 'yes',tickFormatter: function(val, axis) {return val < axis.max ? val.toFixed(0) : "Hz";	} ,
	            axisLabel:"Frequency/Spectral Analysis", axisLabelUseCanvas:true, axisLabelFontSizePixels:10,axisLabelPadding:8,},//axisLabelFontFamily: 'Verdana, Arial',
          
				yaxis: {tickFormatter: function(val, axis) {return val < axis.max ? val.toFixed(0) : "S";	}},
				legend:{show:true,position: "ne"},
				grid: {
				backgroundColor: { colors: ["white", "white"] },//backgroundColor: { colors: ["#4ca8fe", "#2887de"] },
			gridLineColor:"red", borderColor:"gray",borderWidth: 1,	margin:-1, hoverable:true }									   
			});
        }  plotWithOptionsFFT();	
		
		function plotWithOptionsDAMP(){
			  plott = $.plot("#G_DAMP", datasetDAMP, {
				xaxis: {  max:20 , min:0, showTickLabels: 'yes', tickFormatter: function(val, axis) {return val < axis.max ? val.toFixed(0) : "Ïm";},
	            axisLabel:"Decrement ", axisLabelUseCanvas:true, axisLabelFontSizePixels:10,axisLabelPadding:8,},//axisLabelFontFamily: 'Verdana, Arial',
          
				yaxis: { max:10, min:-1, tickFormatter: function(val, axis) {return val < axis.max ? val.toFixed(0) : "ÎÏ";	} },
				legend:{show:true,position: "ne"},
				grid: {
				backgroundColor: { colors: ["white", "white"] },//backgroundColor: { colors: ["#4ca8fe", "#2887de"] },
			    gridLineColor:"red", borderColor:"gray",borderWidth: 1,	margin:-1, hoverable:true }									   
			});
        }  plotWithOptionsDAMP();	

	 
	 


		
		function RZ(){	
		
			Dumpline4.splice(0,Dumpline4.length);  Dumpline5.splice(0,Dumpline5.length);       
			Dumpline6.splice(0,Dumpline6.length);  Dumpline6b.splice(0,Dumpline6b.length); 
			Dumpline7.splice(0,Dumpline7.length);  Dumpline8.splice(0,Dumpline8.length);  //line8.push( [0,0] );
			Dumplinex.splice(0,Dumplinex.length);  Dumpliney.splice(0,Dumpliney.length);
			
			Dumpx_motion.splice(0,Dumpx_motion.length); Dumpx_motiond.splice(0,Dumpx_motiond.length); 
			
			document.getElementById('container32').innerHTML = ' ';
			document.getElementById('Extinctionquation').innerHTML = 'Extinction Eq /';
			document.getElementById('rollperiode').innerHTML = 	'FFT Roll Period';
			document.getElementById('decrementequation').innerHTML = 'Î Eq /';
			
            Phi0=5;
			Dumplinex.push([-Phi0,0]);   Dumplinex.push([50,0]);
			Dumpliney.push([0,-Phi0-1]); Dumpliney.push([0,Phi0+1]);
			plotFixed();
			plotWithOptionsFFT();
			plotWithOptionsDAMP();
			
			//document.getElementById('aware').innerHTML = 'Test   / '  + 1   + '     ' +	'Roll Amplitude ' + Phi0  ;//+ '     ' +	'line8.length ' +line8.length;
			document.getElementById('aware').innerHTML = 'Test   / '  + (Dumpline8.length+1)  + '     ' +	'Roll Amplitude ' + Phi0  ;//+ '     ' +	'line8.length ' +line8.length;
			
			//x_motion.splice(0,x_motion.length);  // call to static NEXTROLL

			limit0 = 0;  iBrt= 0;
			time0 = 0;  Roll0 = [Phi0,0];          // clock RZ
			clock.start(); ; 
			time =  clock.getElapsedTime() ;
		}
		function ButtonRoll(){
			 //RollDecay = !RollDecay;			 //document.getElementById('rollperiode').innerHTML += 'RollDecay/' + RollDecay ;//startTime;
	         //location.reload();
			RZ(); RollDecay = !RollDecay;
		}
		

		// arrPhi = [Phidot, Phidotdot]
		function RollFunction(time, arrPhi) {
		    //var ls=30, B=6, GMt=2, vol=180, Tr =2, ro=1.025, g=9.81;
		    //var ls=40, B=8, GMt=2, vol=300, Tr =2, ro=1.025, g=9.81;
		    var ls=60, B=13, GMt=2, vol=1200, Tr =2, ro=1.025, g=9.81;  //d=5
			
			//var Ixx= g*ro*vol*GMt*(Tr*Tr)/4*(Math.PI*Math.PI);
			var Ixx =0.2*ro*vol*Math.pow(B,2) ;// 1.20*Math.pow(0.4*B,2)*ro*vol ;//Ixx = Ixxp;
			var C44=ro*g*vol*GMt;
			var B44=2*0.1*Math.sqrt(Ixx*C44);

			/**/
			var F = 0; // N
			var Phidotdot = ( F - B44*arrPhi[1] - C44*arrPhi[0]) / Ixx ;
			return [arrPhi[1], Phidotdot];
		};		


        //INITIAL STATE -------------------------------------------------------------------
		function NEXTROLL(Phinext) {
			var sol = numeric.dopri(0, tmax, [Phinext, 0], RollFunction);		//x_motion = numeric.rep([sol.x.length, 2], 0);
			for (var i = 0; i < sol.x.length; i++) {
				 Dumpx_motion.push([sol.x[i],sol.y[i][0]]) // x_motion[i][0] = sol_free.x[i]; x_motion[i][1] = sol_free.y[i][0];
        	}
		}

				
		//Ocean Simulation 
		// NEXTROLL(Phi0);  plotWithOptions();      // Start with Phi0=1Â°  
        //document.getElementById('aware').innerHTML = 'Test   / 1'  + '     ' + 	'Roll Amplitude ' + Phi0 ;
 		document.getElementById('aware').innerHTML = 'Test   / '  + (Dumpline8.length+1)  + '     ' +	'Roll Amplitude ' + Phi0  ;//+ '     ' +	'line8.length ' +line8.length;
		
		function animate() {
			//renderer.clear(); renderer.autoClear = false;

            time =  clock.getElapsedTime() ; 	
			  
			renderer.setRenderTarget( null  );
			renderer.clear();	
			
			window.requestAnimationFrame(animate); 
			renderer.render(scene, camera  );
			controls.update();	
			TWEEN.update();
			
			water.material.uniforms.time.value += 1.0 /30.0; // 2*clock.getDelta();    //1.0 / 10.0;				//swell:------------------------------------------------------------------------------------------ 		   
			water.render(scene, camera );
			
           if (RollDecay == true ) { PROCESSSIGNAL(time)};   //dephasage issue
            //setTimeout( PROCESSSIGNAL(time),10000);
			//PROCESSSIGNAL(time);
		}		
		
		function PROCESSSIGNAL(time){
		
			if (time0 > 50 & time0 < 51 &  Dumpline8.length < ntest) { //stop at line8.length > ntst ****************************
			    document.getElementById('NEXTRoll').innerHTML = ''
			   
				//if (limit0 > samlpeSize  &  line8.length<=ntest) { //stop at line8.length > ntst ****************************
				//NEXTROLL(Phi0);  plotWithOptions();
				//RZ()	
                
				// Graph RZ
				Dumpline4.splice(0,Dumpline4.length);   Dumpline5.splice(0,Dumpline5.length); Dumpline6.splice(0,Dumpline6.length); 
				Dumpline6b.splice(0,Dumpline6b.length); Dumpline7.splice(0,Dumpline7.length); Dumpx_motiond.splice(0,Dumpx_motiond.length);
				Dumpx_motion.splice(0,Dumpx_motiond.length);
				 
				document.getElementById('Extinctionquation').innerHTML = 'Extinction Eq /';
				document.getElementById('rollperiode').innerHTML = 	'FFT Roll Period';
				plotWithOptionsFFT();
			   		   
				//Phi0=Phi0+10;                           // incement roll amplitude	
				//Geo.rotation.x =  Phi0 * Math.PI / 180;
				
				time0 = 0;  Roll0 = [Phi0,0];          // clock RZ
				clock.start();                         // RESTART ************************************************************; 
				time = clock.getElapsedTime() ;
				limit0 = 0;					
//console.log("timetimetimetimetimetimetimetime1111111111111111111111111111111" , time)			
				
				document.getElementById('aware').innerHTML = 'Test   / '  + (Dumpline8.length+1) + '     ' +	'Roll Amplitude ' + Phi0  ;//+ '     ' +	'line8.length ' +line8.length;
				
				Dumpx_motion.splice(0,Dumpx_motion.length);  // call to static NEXTROLL
				// NEXTROLL(Phi0);     plotWithOptions(); // plot next roll 

				//if (Phi0 > 30 ) Phi0=2;                  // loop process
				Dumplinex.push([-0.6*Phi0,0]); Dumplinex.push([50,0]);
				Dumpliney.push([0,-Phi0-2]);   Dumpliney.push([0,Phi0+2]);	
		 	} 	
			 
				 
			if (time - time0 !== 0) //if (time !== 0)
			{	// solve ODE for the time step  and simulate Ship motion
				Roll0 = numeric.dopri(time0, time, Roll0, RollFunction).at(time);
				//Dumpx_motion.push([time,Roll0[0]])  //:this is dynamic process no more needed :replaced by static call to NEXTROLL(Phi0) above  
					
				//if (time0 < 30 ) { //Geo.rotation.set((Roll0[0]*3.14/180).toFixed(4) ,0,0,"YZX");
 				if (limit0 < samlpeSize & Roll0[0] < 50 ) {Geo.rotation.x = Roll0[0]* Math.PI/180}//dopri loop//Geo.rotation.set((Roll0[0]*3.14/180).toFixed(4) ,0,0,"YZX");
                                    
				//if (time0 < 20 ) { //Geo.rotation.set((Roll0[0]*3.14/180).toFixed(4) ,0,0,"YZX");
 				if (limit0 < samlpeSize ) { //Geo.rotation.set((Roll0[0]*3.14/180).toFixed(4) ,0,0,"YZX");
 				                     Dumpx_motiond.push([time , Roll0[0]]);
				                     //Dumpx_motion.push([Roll0[0] , Roll0[1]]);
									 //Dumpx_motiond.push([Roll0.x ,-1*Roll0.y]);		//sol.x[i],sol.y[i][0]
								     plotFixed();
				} 
				time0 = time;		//  document.getElementById('rollperiode').innerHTML += 'time0/' + time0  ;
			}
		    //continous processing of roll signal by call to Periode(time)  
//console.log("timetimetimetimetimetimetimetime2222222222222222222222222222222" , time)				
			if (limit0 <= samlpeSize &  Dumpline8.length<= ntest  ) Periode(time);	
	    }
		
		
	//Initial State
		 
	var clock = new THREE.Clock();
	var startTime ,currentTime ;
	var time  ;
		
	var time0 = 0;
	var time1 = 0;
	var Roll0 = [Phi0, 0];

	Skybox();   //Skydome
	Ocean();  
	Ship();
	animate();	
	
	//setTimeout( function(){   },10000);
	//animate();				   

	</script>

</body>

</html>
